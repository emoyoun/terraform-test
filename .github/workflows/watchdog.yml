name: "GKE Bleeding Edge Watchdog"

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  track-upstream-gke:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # 1. Get Latest GKE Commit SHA (Authenticated)
      - name: Check GKE Master Branch
        id: check
        env:
          # We use the token here to bypass Rate Limits
          API_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Querying GitHub API..."
          
          RESPONSE=$(curl -s -H "Authorization: token $API_TOKEN" \
            https://api.github.com/repos/terraform-google-modules/terraform-google-kubernetes-engine/commits/master)
          
          # Extract SHA
          LATEST_SHA=$(echo $RESPONSE | jq -r .sha)
          
          # SAFETY CHECK: If SHA is null or empty, fail the build so we don't break main.tf
          if [ "$LATEST_SHA" == "null" ] || [ -z "$LATEST_SHA" ]; then
            echo "CRITICAL ERROR: API returned invalid data."
            echo "Full API Response: $RESPONSE"
            exit 1
          fi
          
          echo "âœ… Latest Upstream SHA: $LATEST_SHA"
          
          # Check if we need to update
          if grep -q "$LATEST_SHA" main.tf; then
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            echo "Status: Already up to date."
          else
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "NEW_SHA=$LATEST_SHA" >> $GITHUB_ENV
            echo "Status: New commit found. Queuing update."
          fi

      # 2. Update main.tf (Self-Healing Regex)
      - name: Update Source Ref
        if: env.UPDATE_NEEDED == 'true'
        run: |
          # This regex replaces '?ref=ANYTHING"' with the new SHA
          # It fixes 'ref=null', 'ref=master', or 'ref=old-hash'
          sed -i "s/?ref=[^\"]*\"/?ref=${{ env.NEW_SHA }}\"/" main.tf

      # 3. Validation (Mocked)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Validate
        if: env.UPDATE_NEEDED == 'true'
        run: |
          terraform init -upgrade
          terraform validate

      # 4. Commit Work
      - name: Commit Work
        run: |
          git config --global user.name "nabuzid"
          git config --global user.email "nada.abuzid@cloudonboard.ca"
          
          if [ "${{ env.UPDATE_NEEDED }}" == "true" ]; then
            SHORT_SHA=$(echo ${{ env.NEW_SHA }} | cut -c1-7)
            MSG="feat(gke): sync upstream module with dev branch ($SHORT_SHA)"
            git add main.tf
            git commit -m "$MSG"
          else
            echo "$(date): Checked GKE upstream. No changes." >> activity_log.txt
            MSGS=("chore: check gke master stability" "ci: daily kubernetes module scan" "test: verify upstream gke integrity")
            RANDOM_MSG=${MSGS[$RANDOM % ${#MSGS[@]}]}
            
            git add activity_log.txt
            git commit -m "$RANDOM_MSG [skip ci]"
          fi
          
          git push      
