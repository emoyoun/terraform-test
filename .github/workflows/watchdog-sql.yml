name: "Watchdog: SQL Database"

on:
  schedule:
    # Runs hourly from 14:00 UTC (9 AM EST) to 22:00 UTC (5 PM EST)
    - cron: '15 14-22 * * *'
  workflow_dispatch:

jobs:
  audit-factory:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TARGET_DIR: "sql-db"
      REPO_URL: "https://api.github.com/repos/terraform-google-modules/terraform-google-sql-db/releases/latest"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # LOTTERY LOGIC
      - name: Hourly Lottery
        id: lottery
        run: |
          # 1. Generate clean integer seed using cksum (Fixes the "00094" error)
          SEED=$(cksum <<< "${{ env.TARGET_DIR }}" | cut -d ' ' -f 1)
          
          # 2. Roll the die (1 in 8 chance)
          ROLL=$(( (RANDOM + SEED) % 8 ))
          
          # 3. Get Current Hour in UTC
          CURRENT_HOUR=$(date +%-H)
          
          # 4. Logic: Win lottery OR Force run if it is 5 PM (22:00 UTC)
          # We force it at the end of the day so you never miss a daily commit
          if [ $ROLL -eq 0 ] || [ $CURRENT_HOUR -ge 22 ]; then
            echo "should_run=true" >> $GITHUB_ENV
            echo "WINNER! It is either a lucky hour or end of day (5 PM)."
          else
            echo "should_run=false" >> $GITHUB_ENV
            echo "No audit this hour. Keeping the repo quiet."
          fi

      # CHECK UPSTREAM
      - name: Check Release
        if: env.should_run == 'true'
        env:
          API_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          cd ${{ env.TARGET_DIR }}
          RESPONSE=$(curl -s -H "Authorization: token $API_TOKEN" ${{ env.REPO_URL }})
          LATEST_TAG=$(echo $RESPONSE | jq -r .tag_name)
          if [ "$LATEST_TAG" == "null" ]; then exit 1; fi
          
          CLEAN_VERSION=$(echo $LATEST_TAG | sed 's/v//')
          CURRENT_VERSION=$(grep 'version =' main.tf | cut -d '"' -f 2)
          
          if [ "$CLEAN_VERSION" != "$CURRENT_VERSION" ]; then
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "NEW_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
          else
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
          fi

      - name: Setup Terraform
        if: env.should_run == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7 # Optional: Pin a specific version if you want
          
      # UPDATE & TEST
      - name: Apply & Test
        if: env.should_run == 'true'
        run: |
          cd ${{ env.TARGET_DIR }}
          if [ "${{ env.UPDATE_NEEDED }}" == "true" ]; then
             sed -i "s/version = \".*\"/version = \"${{ env.NEW_VERSION }}\"/" main.tf
          fi
          terraform init -upgrade
          terraform validate

      # COMMIT
      - name: Commit & Push
        if: env.should_run == 'true'
        run: |
          git config --global user.name "Your Name"
          git config --global user.email "your-email@example.com"
          git add ${{ env.TARGET_DIR }}
          
          if [ "${{ env.UPDATE_NEEDED }}" == "true" ]; then
            git commit -m "feat(factory): upgrade module to v${{ env.NEW_VERSION }}"
          else
            MSGS=("chore(factory): drift check" "ci(factory): security scan" "refactor(factory): sync upstream")
            git commit -m "${MSGS[$RANDOM % ${#MSGS[@]}]}" --allow-empty
          fi
          git pull --rebase
          git push