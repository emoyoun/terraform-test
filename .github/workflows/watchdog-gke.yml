name: "GKE Release Watchdog"

on:
  schedule:
    - cron: '0 9 * * *' # Checks every day at 9 AM UTC
  workflow_dispatch:

jobs:
  track-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # 1. Get Latest Release Tag (Authenticated & Safe)
      - name: Check Latest Release
        id: check
        env:
          API_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Querying GitHub API for latest release..."
          
          # We use the /releases/latest endpoint
          RESPONSE=$(curl -s -H "Authorization: token $API_TOKEN" \
            https://api.github.com/repos/terraform-google-modules/terraform-google-kubernetes-engine/releases/latest)
          
          # Extract Tag (e.g., "v31.0.0")
          LATEST_TAG=$(echo $RESPONSE | jq -r .tag_name)
          
          # CRITICAL SAFETY CHECK
          if [ "$LATEST_TAG" == "null" ] || [ -z "$LATEST_TAG" ]; then
            echo "❌ CRITICAL ERROR: API returned invalid data."
            exit 1
          fi
          
          # Clean the version (remove 'v' if present: v30.0.0 -> 30.0.0)
          CLEAN_VERSION=$(echo $LATEST_TAG | sed 's/v//')
          
          echo "✅ Latest Tag: $CLEAN_VERSION"
          
          # Check local version in main.tf
          CURRENT_VERSION=$(grep 'version =' main.tf | cut -d '"' -f 2)
          echo "Current Local: $CURRENT_VERSION"
          
          if [ "$CLEAN_VERSION" != "$CURRENT_VERSION" ]; then
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "NEW_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
            echo "Status: Upgrade available."
          else
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            echo "Status: Up to date."
          fi

      # 2. Update main.tf
      - name: Update Version
        if: env.UPDATE_NEEDED == 'true'
        run: |
          # Robust regex to replace the version number inside quotes
          sed -i "s/version = \".*\"/version = \"${{ env.NEW_VERSION }}\"/" main.tf
          
          # Optional: Update the comment header if it exists
          sed -i "s/Current Upstream Version: .*/Current Upstream Version: ${{ env.NEW_VERSION }}/" main.tf

      # 3. Validation
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Validate
        if: env.UPDATE_NEEDED == 'true'
        run: |
          # -upgrade downloads the new version from the registry
          terraform init -upgrade
          terraform validate

      # 4. Commit Work
      - name: Commit Work
        run: |
          git config --global user.name "nabuzid"
          git config --global user.email "nada.abuzid@cloudonboard.ca"
          
          if [ "${{ env.UPDATE_NEEDED }}" == "true" ]; then
            # Scenario A: Real Version Upgrade
            MSG="feat(deps): upgrade gke module to v${{ env.NEW_VERSION }}"
            git add main.tf
            git commit -m "$MSG"
            
          else
            # Scenario B: Daily Maintenance
            echo "$(date): Checked releases. System stable." >> activity_log.txt
            MSGS=("chore: daily release sync check" "ci: validate upstream release tags" "refactor: release stability scan")
            RANDOM_MSG=${MSGS[$RANDOM % ${#MSGS[@]}]}
            
            git add activity_log.txt
            git commit -m "$RANDOM_MSG [skip ci]"
          fi
          
          git push
